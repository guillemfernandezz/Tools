<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visor Geoquímic</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        /* Leyenda */
        #legend {
            position: absolute; bottom: 30px; right: 20px;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 240px; z-index: 1000;
        }
        #legend h4 { margin: 0 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #333; font-size: 14px; text-transform: uppercase; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; font-size: 13px; color: #555; }
        .color-box { width: 20px; height: 20px; margin-right: 10px; border: 1px solid #ccc; border-radius: 3px; display: inline-block; flex-shrink: 0; }

        /* Popup */
        #popup {
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); border-left: 6px solid #333;
            min-width: 250px; display: none; position: absolute;
            transform: translate(-50%, -100%); margin-top: -15px; z-index: 2000;
        }
        #popup::after {
            content: ""; position: absolute; bottom: -10px; left: 50%;
            margin-left: -10px; border-width: 10px 10px 0;
            border-style: solid; border-color: white transparent;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="legend"><h4>Concentració (%)</h4><div id="content"></div></div>
    <div id="popup"></div>

    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <script>
        // =================================================================
        // 1. CONFIGURACIÓN DE RANGOS Y TEXTOS
        // =================================================================
        // Edita el campo "texto" con los valores de tu captura.
        
        const TABLA_CONFIGURACION = [
            // Valor 1 (Si el valor es < 2)
            { limite: 2,  texto: "Menys de 1,14 %",       hex: "#30123b" }, 
            
            // Valor 2 (Si el valor es < 3)
            { limite: 3,  texto: "Entre 1,14 i 1,27 %",   hex: "#466be3" }, 
            
            // Valor 3 (Rellena esto con tu captura)
            { limite: 4,  texto: "Entre 1,27 i 1,36 %",   hex: "#28bbeb" }, 
            
            // Valor 4
            { limite: 5,  texto: "Entre 1,36 i 1,45 %",   hex: "#32f298" }, 
            
            // Valor 5
            { limite: 6,  texto: "Entre 1,45 i 1,55 %",   hex: "#a4fc3c" }, 
            
            // Valor 6
            { limite: 7,  texto: "Entre 1,55 i 1,62 %",   hex: "#eedd47" }, 
            
            // Valor 7
            { limite: 8,  texto: "Entre 1,62 i 1,72 %",   hex: "#ffa41b" }, 
            
            // Valor 8
            { limite: 9,  texto: "Entre 1,72 i 1,84 %",   hex: "#f56b09" }, 
            
            // Valor 9
            { limite: 10, texto: "Entre 1,84 i 2,09 %",   hex: "#d12e07" }, 
            
            // Valor 10 (Crítico, mayor que el anterior)
            { limite: 9999, texto: "Igual o més de 2,09 %", hex: "#7a0403" }
        ];

        // =================================================================
        // 2. FUNCIONES AUXILIARES
        // =================================================================
        function hexToOL(hex) {
            let c = hex.substring(1).split('');
            if(c.length== 3) c= [c[0], c[0], c[1], c[1], c[2], c[2]];
            c= '0x'+c.join('');
            return [(c>>16)&255, (c>>8)&255, c&255, 1]; 
        }

        // =================================================================
        // 3. GENERAR LEYENDA
        // =================================================================
        const legendDiv = document.getElementById('content');
        TABLA_CONFIGURACION.forEach(item => {
            const row = document.createElement('div');
            row.className = 'legend-item';
            row.innerHTML = `<div class="color-box" style="background:${item.hex}"></div><span>${item.texto}</span>`;
            legendDiv.appendChild(row);
        });

        // =================================================================
        // 4. MAPA
        // =================================================================
        proj4.defs("EPSG:25831","+proj=utm +zone=31 +ellps=GRS80 +units=m +no_defs");
        ol.proj.proj4.register(proj4);

        const source = new ol.source.GeoTIFF({
            sources: [{ 
                url: './distribucio_estimada_Al.tif', 
                nodata: -9999 
            }],
            normalize: false
        });

        const reglasColor = ['case'];
        // Regla transparencia (Valor 0 o NoData)
        reglasColor.push(['==', ['band', 1], 0], [0, 0, 0, 0]);

        // Generar reglas dinámicas desde la tabla
        TABLA_CONFIGURACION.forEach(item => {
            if (item.limite !== 9999) {
                reglasColor.push(['<', ['band', 1], item.limite], hexToOL(item.hex));
            } else {
                reglasColor.push(hexToOL(item.hex));
            }
        });

        const layer = new ol.layer.WebGLTile({
            source: source,
            style: { color: reglasColor }
        });

        const map = new ol.Map({
            target: 'map',
            layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }), layer ],
            view: new ol.View({ projection: 'EPSG:25831', center: [0, 0], zoom: 2 })
        });

        source.getView().then((v) => map.getView().fit(v.extent, { padding: [50, 300, 50, 50] }));

        // =================================================================
        // 5. POPUP
        // =================================================================
        const popup = document.getElementById('popup');
        const overlay = new ol.Overlay({ element: popup, positioning: 'bottom-center', stopEvent: false, offset: [0, -10] });
        map.addOverlay(overlay);

        map.on('click', (evt) => {
            const data = layer.getData(evt.pixel);
            if (data && typeof data[0] === 'number') {
                const val = data[0]; // Este será 1, 2, 3...
                
                if (val === 0) { popup.style.display = 'none'; return; }
                
                const match = TABLA_CONFIGURACION.find(i => val < i.limite) || TABLA_CONFIGURACION[TABLA_CONFIGURACION.length - 1];
                
                popup.style.borderLeftColor = match.hex;
                popup.innerHTML = `
                    <div style="color:#888; font-size:0.9em; text-transform:uppercase;">Rang de Concentració</div>
                    <div style="font-weight:bold; font-size:1.1em; color:#222; margin-top:5px">
                        ${match.texto}
                    </div>
                `;
                overlay.setPosition(evt.coordinate);
                popup.style.display = 'block';
            } else {
                popup.style.display = 'none';
            }
        });

        map.on('pointermove', (evt) => {
            const data = layer.getData(evt.pixel);
            map.getTargetElement().style.cursor = (data && data[0] !== 0) ? 'pointer' : '';
        });
    </script>
</body>
</html>